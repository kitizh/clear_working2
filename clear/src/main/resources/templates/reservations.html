<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Reservations</title>

    <!-- Подключение ваших стилей -->
    <link rel="stylesheet" th:href="@{/css/menu.css}"/>

    <style>
        .reservation-form, .admin-panel {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ccc;
            background-color: #f9f9f9;
        }
        .reservation-form h2 {
            margin-top: 0;
        }
        .reservation-form label {
            display: inline-block;
            width: 150px;
            text-align: right;
            margin-right: 10px;
        }
        .reservation-form .form-row {
            margin-bottom: 10px;
        }
        .reservation-form select,
        .reservation-form input {
            padding: 5px;
            font-size: 14px;
        }
        .reservation-form button {
            margin-top: 10px;
            padding: 6px 12px;
            cursor: pointer;
        }
        .services-list li {
            margin-bottom: 5px;
        }
        .delete-service-btn {
            margin-left: 10px;
            color: red;
            cursor: pointer;
        }
        #serviceCheckboxes div {
            margin-bottom: 5px;
        }
    </style>

    <script type="application/json" id="servicesJson" th:utext="${servicesJson}"></script>
</head>
<body>

<nav>
    <ul>
        <li><a href="/" class="home-button">Главная</a></li>
        <li><a href="/menu">Меню</a></li>
        <li><a href="/orders">Заказы</a></li>
        <li><a href="/reserve" class="active">Брони</a></li>
    </ul>
</nav>

<div class="container">

    <!-- Форма для создания новой брони -->
    <div class="reservation-form">
        <h2>Создать новую бронь</h2>

        <div class="form-row">
            <label for="tableId">Столик:</label>
            <select id="tableId">
                <option value="">--Выбрать--</option>
                <option th:each="t : ${allTables}"
                        th:value="${t.id}"
                        th:text="${'Стол ' + t.id + ' (мест: ' + t.seats + ')'}"></option>
            </select>
        </div>

        <div class="form-row">
            <label for="reservationDate">Дата:</label>
            <input type="date" id="reservationDate"/>
        </div>

        <div class="form-row">
            <label for="reservationTime">Время:</label>
            <select id="reservationTime" disabled>
                <!-- Время будет динамически заполняться -->
            </select>
        </div>

        <div class="form-row">
            <label for="resName">Имя:</label>
            <input type="text" id="resName"/>
        </div>

        <div class="form-row">
            <label for="resPhone">Телефон:</label>
            <input type="text" id="resPhone"/>
        </div>

        <div class="form-row">
            <label>Услуги:</label>
            <div id="serviceCheckboxes">
                <div th:each="srv : ${services}">
                    <input type="checkbox" name="services" id="srv-[[${srv.id}]]" th:value="${srv.id}">
                    <label for="srv-[[${srv.id}]]" th:text="${srv.serviceName}"></label>
                </div>
            </div>
        </div>

        <button id="createReservationBtn">Create Reservation</button>
    </div>

    <!-- Блок админа -->
    <div class="admin-panel" th:if="${isAdmin}">
        <h2>Управление Бронями</h2>

        <!-- Фильтрация по столикам -->
        <div class="form-row">
            <label for="tableFilter">Фильтрация по столикам:</label>
            <select id="tableFilter">
                <option value="">-- Все столики --</option>
                <option th:each="t : ${allTables}" th:value="${t.id}" th:text="${'Стол ' + t.id}"></option>
            </select>
        </div>

        <div class="admin-actions">
            <button id="edit-button">Edit</button>
        </div>

        <table class="menu-table">
            <colgroup>
                <col style="width: 10%;">
                <col style="width: 20%;">
                <col style="width: 15%;">
                <col style="width: 15%;">
                <col style="width: 15%;">
                <col style="width: 20%;">
            </colgroup>
            <thead>
            <tr>
                <th id="sortId" class="sortable">ID <span class="sort-direction">▲</span></th>
                <th id="sortTable" class="sortable">Столик</th>
                <th id="sortTime" class="sortable">Дата и время брони</th>
                <th>Имя</th>
                <th>Телефон</th>
                <th class="actions-column">Действия</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="r : ${reservations}" class="reservation-row" th:data-id="${r.id}" th:data-table-id="${r.table.id}">
                <td class="res-id editable" th:text="${r.id}"></td>
                <td class="res-table editable" th:text="${r.table != null ? r.table.id : 'N/A'}"></td>
                <td class="res-time editable" th:text="${#temporals.format(r.reservationDate, 'yyyy-MM-dd') + ' ' + #temporals.format(r.reservationTime, 'HH:mm')}"></td>
                <td class="res-name editable" th:text="${r.name}"></td>
                <td class="res-phone editable" th:text="${r.phoneNumber}"></td>
                <td class="actions-column">
                    <button class="delete-res-btn" style="display: none;">Delete</button>
                </td>
            </tr>

            <tr th:if="${#lists.isEmpty(reservations)}">
                <td colspan="6">Бронирований пока нет</td>
            </tr>
            </tbody>
        </table>

        <hr/>

        <h3>Услуги для брони #<span id="currentResId"></span></h3>
        <ul id="serviceList" class="services-list">
            <li>Ничего не выбрано</li>
        </ul>

        <div>
            <label>Добавить услуги:</label>
            <select id="adminServiceSelect" multiple size="4" style="width: 200px;">
                <option th:each="srv : ${services}" th:value="${srv.id}" th:text="${srv.serviceName}"></option>
            </select>
            <button id="addServicesBtn">Add Services</button>
        </div>
    </div>

</div>

<script th:inline="javascript">
    let currentSortColumn = null;
    let currentSortDirection = 'asc';

    function sortTable(columnIndex) {
        const table = document.querySelector('.menu-table tbody');
        const rows = Array.from(table.rows);
        const currentColumn = table.querySelectorAll('th')[columnIndex];

        // Проверяем направление сортировки
        const direction = currentSortColumn === columnIndex && currentSortDirection === 'asc' ? 'desc' : 'asc';
        rows.sort((rowA, rowB) => {
            const cellA = rowA.cells[columnIndex].textContent.trim();
            const cellB = rowB.cells[columnIndex].textContent.trim();

            if (direction === 'asc') {
                return cellA > cellB ? 1 : -1;
            } else {
                return cellA < cellB ? 1 : -1;
            }
        });

        // Сортируем и обновляем таблицу
        table.innerHTML = '';
        rows.forEach(row => table.appendChild(row));
        currentSortColumn = columnIndex;
        currentSortDirection = direction;

        // Обновляем стрелочки
        updateSortArrows(columnIndex, direction);
    }

    function updateSortArrows(columnIndex, direction) {
        const arrows = document.querySelectorAll('.sort-arrow');
        arrows.forEach(arrow => arrow.remove());
        const th = document.querySelectorAll('.menu-table th')[columnIndex];
        const arrow = document.createElement('span');
        arrow.classList.add('sort-arrow');
        arrow.textContent = direction === 'asc' ? '↑' : '↓';
        th.appendChild(arrow);
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Обработчик изменения столика или даты
        const tableSelect = document.getElementById('tableId');
        const dateInput = document.getElementById('reservationDate');
        const timeSelect = document.getElementById('reservationTime');

        const applyFiltersBtn = document.getElementById('applyFiltersBtn');
        if (applyFiltersBtn) {
            applyFiltersBtn.addEventListener('click', () => {
                const selectedTables = Array.from(document.querySelectorAll('#tableFilter input[type="checkbox"]:checked')).map(chk => chk.value);
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;

                filterReservations(selectedTables, startDate, endDate);
            });
        }

        tableSelect.addEventListener('change', updateAvailableTimes);
        dateInput.addEventListener('change', updateAvailableTimes);

        function updateAvailableTimes() {
            const tableId = tableSelect.value;
            const reservationDate = dateInput.value;

            if (!tableId || !reservationDate) {
                timeSelect.disabled = true;
                return;
            }

            timeSelect.disabled = false;

            const reservedTimes = getReservedTimes(tableId, reservationDate);
            const options = timeSelect.querySelectorAll('option');
            options.forEach(option => {
                const time = option.value;
                if (reservedTimes.includes(time)) {
                    option.disabled = true;
                } else {
                    option.disabled = false;
                }
            });
        }

        function getReservedTimes(tableId, reservationDate) {
            // Псевдокод: запрос на сервер для получения занятых времен для данного столика на указанную дату
            // Пример возвращаемого массива: ["12:00", "15:00"]
            return ["12:00", "15:00"]; // Замени на реальные данные из сервера
        }

        // ------------------- Фильтрация по столикам -------------------
        const tableFilter = document.getElementById('tableFilter');
        tableFilter.addEventListener('change', () => {
            const selectedTable = tableFilter.value;
            const rows = document.querySelectorAll('.reservation-row');
            rows.forEach(row => {
                const tableId = row.getAttribute('data-table-id');
                row.style.display = (selectedTable === "" || selectedTable === tableId) ? '' : 'none';
            });
        });

        // ------------------- Сортировка -------------------
        document.querySelectorAll('.menu-table th').forEach((th, index) => {
            th.addEventListener('click', () => sortTable(index));
        });

        sortTable(0);

        // ------------------- Режим редактирования -------------------
        let editMode = false;
        const editBtn = document.getElementById('edit-button');
        if (editBtn) {
            editBtn.addEventListener('click', () => {
                editMode = !editMode;
                document.body.classList.toggle('edit-mode', editMode);
                editBtn.textContent = editMode ? 'Save' : 'Edit';

                document.querySelectorAll('.reservation-row .editable').forEach(cell => {
                    cell.contentEditable = editMode;
                    cell.classList.toggle('editing', editMode);
                });
                document.querySelectorAll('.delete-res-btn').forEach(btn => {
                    btn.style.display = editMode ? 'inline-block' : 'none';
                });

                if (!editMode) {
                    saveReservations();
                }
            });
        }

        function saveReservations() {
            const rows = document.querySelectorAll('.reservation-row');
            const dataToSend = [];
            rows.forEach(row => {
                const id = row.querySelector('.res-id').textContent.trim();
                let dateTimeVal = row.querySelector('.res-time').textContent.trim();
                const parts = dateTimeVal.split(' ');
                if (parts.length < 2) {
                    alert('Неверный формат даты и времени: ' + dateTimeVal);
                    return;
                }
                const reservationDate = parts[0];
                let reservationTime = parts[1];
                if (reservationTime.length === 5) {
                    reservationTime += ":00";
                }
                const nameVal = row.querySelector('.res-name').textContent.trim();
                const phoneVal = row.querySelector('.res-phone').textContent.trim();

                dataToSend.push({
                    id: id,
                    reservationDate: reservationDate,
                    reservationTime: reservationTime,
                    name: nameVal,
                    phoneNumber: phoneVal
                });
            });
            fetch('/reserve/update', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(dataToSend)
            })
                .then(r => {
                    if (!r.ok) alert('Ошибка при сохранении изменений');
                });
        }

        // ------------------- Загрузка услуг для каждой брони -------------------
        document.querySelectorAll('.res-id').forEach(cell => {
            cell.addEventListener('click', () => {
                const row = cell.closest('.reservation-row');
                const resId = row.getAttribute('data-id');
                loadReservationServices(resId);
            });
        });

        function loadReservationServices(resId) {
            fetch(`/reserve/${resId}/services`)
                .then(r => r.json())
                .then(data => {
                    const serviceList = document.getElementById('serviceList');
                    const currentResIdSpan = document.getElementById('currentResId');
                    currentResIdSpan.textContent = resId;
                    if (data.length === 0) {
                        serviceList.innerHTML = '<li>Нет услуг</li>';
                    } else {
                        serviceList.innerHTML = '';
                        data.forEach(item => {
                            const li = document.createElement('li');
                            li.textContent = item.serviceName + ' — ' + item.description;
                            const delBtn = document.createElement('span');
                            delBtn.textContent = ' [X]';
                            delBtn.classList.add('delete-service-btn');
                            delBtn.addEventListener('click', () => {
                                deleteReservationService(resId, item.reservedServiceId, li);
                            });
                            li.appendChild(delBtn);
                            serviceList.appendChild(li);
                        });
                    }
                })
                .catch(e => console.error(e));
        }

        function deleteReservationService(resId, rsId, liElement) {
            fetch(`/reserve/${resId}/services/delete/${rsId}`, {method: 'POST'})
                .then(r => {
                    if (r.ok) {
                        liElement.remove();
                    } else {
                        alert('Ошибка при удалении услуги');
                    }
                });
        }

        // ------------------- Добавление услуг -------------------
        const addServicesBtn = document.getElementById('addServicesBtn');
        if (addServicesBtn) {
            addServicesBtn.addEventListener('click', () => {
                const resId = document.getElementById('currentResId').textContent.trim();
                if (!resId) {
                    alert('Сначала выберите бронь');
                    return;
                }

                const adminServiceSelect = document.getElementById('adminServiceSelect');
                const selected = Array.from(adminServiceSelect.selectedOptions).map(o => parseInt(o.value));

                if (selected.length === 0) {
                    alert('Выберите хотя бы одну услугу');
                    return;
                }

                fetch(`/reserve/${resId}/services/add`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({serviceIds: selected})
                })
                    .then(r => {
                        if (r.ok) {
                            loadReservationServices(resId);
                            adminServiceSelect.selectedIndex = -1;
                        } else {
                            alert('Ошибка при добавлении услуг');
                        }
                    });
            });
        }

        // ------------------- Создание новой брони -------------------
        const createBtn = document.getElementById('createReservationBtn');
        if (createBtn) {
            createBtn.addEventListener('click', () => {
                const tableId = document.getElementById('tableId').value.trim();
                const reservationDate = document.getElementById('reservationDate').value.trim();
                const reservationTime = document.getElementById('reservationTime').value.trim();
                const name = document.getElementById('resName').value.trim();
                const phone = document.getElementById('resPhone').value.trim();

                if (!tableId || !reservationDate || !reservationTime || !name || !phone) {
                    alert('Пожалуйста, заполните все поля');
                    return;
                }

                const formattedTime = reservationTime.length === 5 ? reservationTime + ":00" : reservationTime;

                const payload = {
                    tableId: parseInt(tableId),
                    reservationDate: reservationDate,
                    reservationTime: formattedTime,
                    name: name,
                    phone: phone,
                    services: Array.from(document.querySelectorAll('#serviceCheckboxes input[type=checkbox]'))
                        .filter(chk => chk.checked)
                        .map(chk => parseInt(chk.value))
                };

                fetch('/reserve/new', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                })
                    .then(r => r.json())
                    .then(resp => {
                        if (resp.reservationId) {
                            alert('Бронь на ' + reservationDate + ' ' + formattedTime + ' успешно создана!');
                            document.getElementById('tableId').value = "";
                            document.getElementById('reservationDate').value = "";
                            document.getElementById('reservationTime').selectedIndex = 0;
                            document.getElementById('resName').value = "";
                            document.getElementById('resPhone').value = "";
                            document.querySelectorAll('#serviceCheckboxes input[type=checkbox]')
                                .forEach(chk => chk.checked = false);
                        } else {
                            alert('Ошибка: ' + JSON.stringify(resp));
                        }
                    })
                    .catch(err => alert('Ошибка: ' + err));
            });
        }
    });
</script>

</body>
</html>
